<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Archive | WEEBOKAGE</title>
    <!-- Cache-Buster v11.2 -->
    <link rel="stylesheet" href="style.css?v=11.2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'miku';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <style>
        .anime-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; margin-top: 30px; }
        .ani-card { padding: 0 !important; overflow: hidden; border-bottom: 4px solid var(--primary); height: 400px; display: flex; flex-direction: column; transition: 0.3s; cursor: pointer; position: relative; }
        .ani-card:hover { transform: translateY(-10px); box-shadow: 0 10px 30px var(--primary-glow); }
        .ani-card img { width: 100%; height: 280px; object-fit: cover; }
        .ani-info { padding: 12px; background: rgba(10, 11, 16, 0.9); flex: 1; }
        .ani-title { font-size: 0.85rem; font-weight: bold; color: var(--primary); height: 2.5em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .ani-score { position: absolute; top: 10px; right: 10px; background: var(--primary); color: #000; padding: 3px 8px; border-radius: 5px; font-weight: bold; font-size: 0.75rem; z-index: 5; }

        /* ===== MODAL STYLING ===== */
        #anime-modal-backdrop {
            display: none; position: fixed; inset: 0; z-index: 9000;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            overflow-y: auto; padding: 40px 20px;
        }
        #anime-modal-backdrop.open { display: flex; justify-content: center; align-items: flex-start; }
        #anime-modal {
            background: rgba(10, 11, 16, 0.97); border: 1px solid var(--primary);
            box-shadow: 0 0 40px var(--primary-glow); border-radius: 20px;
            width: 100%; max-width: 960px; position: relative; overflow: hidden;
            animation: modalIn 0.35s ease;
        }
        @keyframes modalIn { from { opacity:0; transform: scale(0.93) translateY(30px); } to { opacity:1; transform: scale(1) translateY(0); } }
        #modal-close {
            position: absolute; top: 18px; right: 20px; z-index: 10;
            background: var(--primary); color: #000; border: none; border-radius: 50%; 
            width: 36px; height: 36px; font-size: 1.2rem; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        #modal-banner { display: flex; gap: 0; min-height: 320px; background: #000; }
        #modal-cover { width: 220px; min-width: 220px; object-fit: cover; border-right: 2px solid var(--primary); }
        #modal-header-info { padding: 30px; flex: 1; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(to right, rgba(10,11,16,0.3), rgba(10,11,16,0.95)); }
        #modal-title-en { font-size: 1.8rem; font-weight: bold; color: var(--primary); line-height: 1.2; }
        .modal-badge { background: rgba(255,255,255,0.07); border: 1px solid var(--primary); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; margin-right: 5px; margin-top: 10px; display: inline-block; }
        .modal-section-title { color: var(--primary); font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 3px; border-left: 3px solid var(--primary); padding-left: 10px; margin: 35px 0 15px; }
        
        /* Stats Grid */
        #modal-stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .stat-item { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 10px; text-align: center; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
        .stat-lbl { font-size: 0.6rem; opacity: 0.5; text-transform: uppercase; }

        /* Characters Grid */
        #modal-chars-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .char-card { background: rgba(255,255,255,0.03); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08); transition: 0.3s; }
        .char-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .char-card img { width: 100%; height: 140px; object-fit: cover; }
        .char-info { padding: 10px; }
        .char-name { font-size: 0.75rem; font-weight: bold; color: var(--primary); }
        .char-role { font-size: 0.6rem; opacity: 0.5; margin-bottom: 5px; }
        .char-va { font-size: 0.65rem; opacity: 0.8; color: #ddd; }

        /* Relations */
        .relation-item { display: flex; gap: 15px; background: rgba(255,255,255,0.03); padding: 10px 15px; border-radius: 10px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); }
        .rel-type { font-size: 0.7rem; font-weight: bold; color: var(--primary); width: 80px; text-transform: uppercase; }
        .rel-name { font-size: 0.8rem; opacity: 0.9; }
    </style>
</head>
<body>

    <div class="theme-switch-wrapper">
        <span onclick="setTheme('miku')" style="cursor:pointer; font-size: 1.2rem;">ü©µ</span>
        <label class="switch"><input type="checkbox" id="theme-toggle" onclick="themeToggle()"><span class="slider"></span></label>
        <span onclick="setTheme('teto')" style="cursor:pointer; font-size: 1.2rem;">ü•ñ</span>
    </div>

    <nav>
        <div class="links">
            <a href="index.html">Home</a>
            <a href="transit.html">Transit</a>
            <a href="anime.html">Anime</a>
            <a href="islam.html" class="admin-hide" id="nav-islam">Islam</a>
            <a href="games.html">Games</a>
            <a href="credits.html">Credits</a>
            <a href="login.html">Admin</a>
        </div>
    </nav>

    <div class="container">
        <div style="text-align: center; margin-bottom: 50px;">
            <h1 style="color: var(--primary); letter-spacing: 4px; text-transform: uppercase;">Anime Database</h1>
            <div class="card" style="max-width: 600px; margin: 20px auto; padding: 20px;">
                <div class="input-group" style="margin-bottom: 0;">
                    <input type="text" id="aniSearch" placeholder="Search for an anime title..." onkeypress="if(event.key === 'Enter') searchAnime()">
                    <i class="fas fa-search"></i>
                </div>
                <button onclick="searchAnime()" class="btn" style="width: 100%; margin-top: 15px; letter-spacing: 2px;">START UPLINK</button>
            </div>
        </div>

        <h2 id="grid-header" style="color: var(--primary); border-left: 4px solid var(--primary); padding-left: 15px; letter-spacing: 1px;">DATA STREAM: TRENDING</h2>
        <div class="anime-grid" id="anime-results"></div>
    </div>

    <!-- DETAIL MODAL -->
    <div id="anime-modal-backdrop" onclick="handleBackdropClick(event)">
        <div id="anime-modal">
            <button id="modal-close" onclick="closeModal()">‚úï</button>
            <div id="modal-content"></div>
        </div>
    </div>

    <!-- MIKU AI CHAT -->
    <div id="miku-chat-container" style="position: fixed; bottom: 20px; left: 20px; z-index: 2000;">
        <div id="miku-window" style="display: none; width: 350px; height: 500px; background: rgba(10,11,16,0.95); backdrop-filter: blur(20px); border: 2px solid var(--primary); border-radius: 20px; flex-direction: column; overflow: hidden; box-shadow: 0 0 30px var(--primary-glow); margin-bottom: 15px;">
            <div style="background: var(--primary); color: black; padding: 12px; font-weight: bold; display: flex; justify-content: space-between;">
                <span id="ai-title">MIKU SYSTEM 01</span>
                <span onclick="toggleMiku()" style="cursor: pointer;">&times;</span>
            </div>
            <div id="miku-msgs" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; font-size: 0.9rem;"></div>
            <div style="padding: 15px; display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                <input type="text" id="miku-input" placeholder="Type message..." style="margin:0; border-radius: 12px;">
                <button onclick="askMiku()" class="btn" style="width: 50px; height: 50px; border-radius: 50%; padding: 0;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div id="miku-btn" onclick="toggleMiku()" style="width: 70px; height: 70px; border-radius: 50%; background-image: var(--pfp); background-size: cover; border: 3px solid var(--primary); cursor: pointer; box-shadow: 0 0 20px var(--primary-glow);"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAj4pBH0zjbCIbUHp0ldmW8eU8pJTZnquo", authDomain: "weebokage-296c0.firebaseapp.com", projectId: "weebokage-296c0", storageBucket: "weebokage-296c0.firebasestorage.app", messagingSenderId: "192569800499", appId: "1:192569800499:web:4c5ef67242b7fdd0b2b046" };
        firebase.initializeApp(firebaseConfig);

        firebase.auth().onAuthStateChanged(user => {
            if (user) document.getElementById('nav-islam')?.style.setProperty('display', 'inline-block', 'important');
        });

        // --- FETCHING LOGIC ---
        async function fetchAnime(search = "") {
            const resultsDiv = document.getElementById('anime-results');
            resultsDiv.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>Connecting to Miku-Backend Tunnel...</p>";
            try {
                const res = await fetch(`https://weebokageofficial-github-io.onrender.com/anime-proxy?search=${search}`);
                const list = await res.json();
                resultsDiv.innerHTML = list.map(ani => `
                    <div class="card ani-card" onclick="openAnimeDetail(${ani.mal_id})">
                        <div class="ani-score">‚≠ê ${ani.score || '??'}</div>
                        <img src="${ani.images.jpg.large_image_url || ani.images.jpg.image_url}">
                        <div class="ani-info">
                            <div class="ani-title">${ani.title}</div>
                            <div style="font-size:0.65rem; opacity:0.6; margin-top:5px;">${ani.type} ‚Ä¢ ${ani.status}</div>
                        </div>
                    </div>`).join('');
            } catch (e) { resultsDiv.innerHTML = "Uplink Failure: Backend is offline!"; }
        }

        async function openAnimeDetail(malId) {
            const backdrop = document.getElementById('anime-modal-backdrop');
            const content  = document.getElementById('modal-content');
            content.innerHTML = '<div style="text-align:center; padding:100px; color:var(--primary)">Accessing Data Fragments...</div>';
            backdrop.classList.add('open');
            document.body.style.overflow = 'hidden';
            try {
                const res = await fetch(`https://weebokageofficial-github-io.onrender.com/anime-detail/${malId}`);
                const data = await res.json();
                renderModal(data);
            } catch (e) { content.innerHTML = "Error: Uplink timed out."; }
        }

        function renderModal(data) {
            const info = data.info || {};
            const chars = data.characters || [];
            const rels = data.relations || [];
            const title = info.title_english || info.title;

            // --- CHARACTERS HTML ---
            const charsHTML = chars.length ? chars.map(c => {
                const va = c.voice_actors.find(v => v.language === 'Japanese');
                return `
                <div class="char-card">
                    <img src="${c.character.images.jpg.image_url}">
                    <div class="char-info">
                        <div class="char-name">${c.character.name}</div>
                        <div class="char-role">${c.role}</div>
                        <div class="char-va">${va ? 'üéô ' + va.person.name : ''}</div>
                    </div>
                </div>`;
            }).join('') : '<p style="opacity:0.5">No character data found.</p>';

            // --- RELATIONS HTML ---
            const relHTML = rels.length ? rels.map(r => `
                <div class="relation-item">
                    <span class="rel-type">${r.relation}</span>
                    <span class="rel-name">${r.entry[0].name}</span>
                </div>`).join('') : '<p style="opacity:0.5">No relations found.</p>';

            document.getElementById('modal-content').innerHTML = `
                <div id="modal-banner">
                    <img id="modal-cover" src="${info.images?.jpg?.large_image_url}">
                    <div id="modal-header-info">
                        <div id="modal-title-en">${title}</div>
                        <div><span class="modal-badge">‚≠ê ${info.score || 'N/A'}</span><span class="modal-badge">Rank #${info.rank || 'N/A'}</span></div>
                    </div>
                </div>
                <div style="padding:30px;">
                    <div class="modal-section-title">Statistics</div>
                    <div id="modal-stats-grid">
                        <div class="stat-item"><div class="stat-val">${info.episodes || '?'}</div><div class="stat-lbl">Episodes</div></div>
                        <div class="stat-item"><div class="stat-val">${info.status}</div><div class="stat-lbl">Status</div></div>
                        <div class="stat-item"><div class="stat-val">${info.duration}</div><div class="stat-lbl">Duration</div></div>
                        <div class="stat-item"><div class="stat-val">${info.rating || 'N/A'}</div><div class="stat-lbl">Rating</div></div>
                    </div>

                    <div class="modal-section-title">Synopsis</div>
                    <p style="font-size:0.9rem; line-height:1.6; opacity:0.8; text-align:justify;">${info.synopsis || 'No summary available.'}</p>

                    <div class="modal-section-title">Characters & Voice Actors</div>
                    <div id="modal-chars-grid">${charsHTML}</div>

                    <div class="modal-section-title">Related Media</div>
                    <div id="modal-relations-list">${relHTML}</div>
                </div>`;
        }

        function searchAnime() { fetchAnime(document.getElementById('aniSearch').value); }
        function closeModal() { document.getElementById('anime-modal-backdrop').classList.remove('open'); document.body.style.overflow = ''; }
        function handleBackdropClick(e) { if(e.target.id === 'anime-modal-backdrop') closeModal(); }

        // --- UI LOGIC ---
        function setTheme(t) {
            const oldTheme = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t);
            document.getElementById('theme-toggle').checked = (t === 'teto');
            document.getElementById('ai-title').innerText = (t === 'teto') ? "TETO SYSTEM 04" : "MIKU SYSTEM 01";
            if(oldTheme !== t || document.getElementById('miku-msgs').innerHTML === "") {
                const box = document.getElementById('miku-msgs'); box.innerHTML = "";
                const msg = (t === 'teto') ? "Master! Teto 04 here. Check out the voice cast! ü•ñ" : "Master! Miku 01 here. I've listed the characters for you! ü©µ";
                box.innerHTML = `<div style="background: rgba(57, 197, 187, 0.1); padding: 12px; border-radius: 12px; border: 1px solid var(--primary); align-self: flex-start; max-width: 85%;">${msg}</div>`;
            }
        }
        setTheme(localStorage.getItem('theme') || 'miku');
        function themeToggle() { setTheme(document.getElementById('theme-toggle').checked ? 'teto' : 'miku'); }
        function toggleMiku() { const win = document.getElementById('miku-window'); win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none'; }
        
        async function askMiku() {
            const inp = document.getElementById('miku-input'); const box = document.getElementById('miku-msgs'); const val = inp.value.trim();
            if(!val) return;
            box.innerHTML += `<div style="background: var(--primary); color: black; padding: 12px; border-radius: 12px; align-self: flex-end; max-width: 85%; font-weight: bold;">${val}</div>`;
            inp.value = "";
            const load = document.createElement("div"); load.style.cssText = "background: rgba(57, 197, 187, 0.1); padding: 12px; border-radius: 12px; border: 1px solid var(--primary); align-self: flex-start;";
            load.innerText = "..."; box.appendChild(load); box.scrollTop = box.scrollHeight;
            try {
                const res = await fetch("https://weebokageofficial-github-io.onrender.com/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ message: val, theme: localStorage.getItem('theme') || 'miku' }) });
                const data = await res.json(); load.innerText = data.reply;
            } catch (e) { load.innerText = "Connection lost."; }
            box.scrollTop = box.scrollHeight;
        }
        document.getElementById('miku-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') askMiku(); });

        fetchAnime(); 
    </script>
</body>
</html>